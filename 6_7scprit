local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()

-- [[ CẤU HÌNH HỆ THỐNG KEY ]] --
local CORRECT_KEY = "6_7HUB-VIP" 
local DISCORD_LINK = "https://discord.gg/DBFVrAzbB"
local KEY_FILE = "6_7Hub_Config.txt"

-- [[ HÀM HỖ TRỢ ]] --
local function SaveKey(key)
    if writefile then writefile(KEY_FILE, key) end
end

local function GetSavedKey()
    if isfile and isfile(KEY_FILE) then return readfile(KEY_FILE) end
    return ""
end

-- [[ HÀM CHỨA MENU CHÍNH ]] --
function LoadMainHub()
    local Player = game:GetService("Players").LocalPlayer
    local PlaceID = game.PlaceId
    
    -- Khởi tạo Window chính
    local Window = Fluent:CreateWindow({
        Title = "6_7 Hub | Premium Edition",
        SubTitle = "by 6_7 Team",
        TabWidth = 160,
        Size = UDim2.fromOffset(580, 420),
        Acrylic = true,
        Theme = "Amethyst",
        MinimizeKey = Enum.KeyCode.End
    })

    -- FIX LỖI: Kiểm tra nếu Window khởi tạo thành công mới tạo Tab
    if not Window then
        warn("Fluent: Không thể tạo Window!")
        return
    end

    local Tabs = {
        Main = Window:AddTab({ Title = "Trang Chủ", Icon = "home" }),
        Settings = Window:AddTab({ Title = "Cài Đặt", Icon = "settings" })
    }

    -- PHÂN LOẠI GAME
    if PlaceID == 10449761463 then
        Tabs.Game = Window:AddTab({ Title = "JJS", Icon = "zap" })
        Tabs.Game:AddButton({Title = "Spotlight Hub", Callback = function() loadstring(game:HttpGet('https://raw.githubusercontent.com/NotEnoughJack/localplayerscripts/refs/heads/main/script'))() end})
    elseif PlaceID == 2753915549 or PlaceID == 4442272183 or PlaceID == 7449423635 then
        Tabs.Game = Window:AddTab({ Title = "Blox Fruits", Icon = "sword" })
        Tabs.Game:AddButton({Title = "Redz Hub", Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/newredz/BloxFruits/refs/heads/main/Source.luau"))() end})
    end

    -- TAB CÀI ĐẶT
    Tabs.Settings:AddButton({
        Title = "Rejoin Server",
        Callback = function() game:GetService("TeleportService"):Teleport(game.PlaceId, Player) end
    })

    -- [[ FIX LỖI NÚT TRÒN TOGGLE ]] --
    -- Xóa nút cũ nếu có để tránh trùng lặp
    if game.CoreGui:FindFirstChild("67Hub_Toggle") then
        game.CoreGui["67Hub_Toggle"]:Destroy()
    end

    local ScreenGui = Instance.new("ScreenGui")
    local ImageButton = Instance.new("ImageButton")
    local UICorner = Instance.new("UICorner")

    ScreenGui.Name = "67Hub_Toggle"
    ScreenGui.Parent = game.CoreGui
    
    ImageButton.Parent = ScreenGui
    ImageButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    ImageButton.Size = UDim2.new(0, 50, 0, 50)
    ImageButton.Position = UDim2.new(0.1, 0, 0.2, 0)
    ImageButton.Draggable = true
    ImageButton.Active = true
    ImageButton.Image = "rbxassetid://83932975706860"
    
    UICorner.CornerRadius = UDim.new(1, 0)
    UICorner.Parent = ImageButton

    -- Sửa logic click: Fluent sử dụng Minimize() để ẩn/hiện
    ImageButton.MouseButton1Click:Connect(function()
        Window:Minimize() 
    end)

    Window:SelectTab(1)
    
    Fluent:Notify({
        Title = "6_7 Hub",
        Content = "Menu đã sẵn sàng!",
        Duration = 3
    })
end

-- [[ HỆ THỐNG KIỂM TRA KEY ]] --
local function StartKeySystem()
    local Saved = GetSavedKey()
    
    -- Nếu đã có key đúng, vào thẳng Hub
    if Saved == CORRECT_KEY then
        LoadMainHub()
        return
    end

    -- Nếu chưa có, hiện bảng nhập Key
    local KeyWindow = Fluent:CreateWindow({
        Title = "6_7 Hub | Authentication",
        SubTitle = "Hệ Thống Xác Thực",
        TabWidth = 160,
        Size = UDim2.fromOffset(450, 300),
        Acrylic = true,
        Theme = "Amethyst",
        MinimizeKey = Enum.KeyCode.End
    })

    local KeyTab = KeyWindow:AddTab({ Title = "Xác Thực", Icon = "key" })
    
    local KeyInput = KeyTab:AddInput("Input", {
        Title = "Nhập mã Key",
        Default = "",
        Placeholder = "Dán key tại đây...",
        Callback = function() end
    })

    KeyTab:AddButton({
        Title = "Xác Nhận (Login)",
        Callback = function()
            if KeyInput.Value == CORRECT_KEY then
                SaveKey(KeyInput.Value)
                Fluent:Notify({Title = "Thành Công!", Content = "Đang mở Menu...", Duration = 3})
                task.wait(0.5)
                KeyWindow:Destroy()
                task.wait(0.2) -- Đợi một chút để UI cũ xóa sạch
                LoadMainHub()
            else
                Fluent:Notify({Title = "Lỗi", Content = "Mã Key không chính xác!", Duration = 5})
            end
        end
    })

    KeyTab:AddButton({
        Title = "Lấy Key",
        Callback = function()
            setclipboard(DISCORD_LINK)
            Fluent:Notify({Title = "Thông báo", Content = "Đã copy link Discord!", Duration = 5})
        end
    })
end

-- Chạy hệ thống
StartKeySystem()
